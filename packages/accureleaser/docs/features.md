# 工具架构

## 功能实现列表

### 用户功能

- 在主分支上新建开发分支
- 在开发分支上新建开发分支
- 自动标记在其他地方新建的无效开发分支
- 自动修复更改了代码但未进入开发版本的包
- （自动）引入新的正式版
- （自动）阻挡未引入正式版的提交
- PR 辅助
- 自动删除已被合并的依赖分支
- 合并开发分支，也就是添加依赖分支

### 持续部署功能

- 检查更改了代码但未进入开发版本的包
- 发布开发版本
- 验证开发版本是否与正式版本相同
- 验证开发阶段是否足够 PR
- 生成 changelog
- 正式版本、前瞻版本的版本号递增
- 发布正式版本、前瞻版本
- 删除不需要的开发标签

## 元数据如何记录

元数据是与具体开发无关的，功能快速开发产生的，无法快速直接通过仓库得到的仓库描述数据。

在开发时，我们会产生以下元数据：

|元数据|何时产生|
|-|-|
|开发分支所开发的功能的描述|在分支被创建时|
|开发分支修改的包的列表|在包被修改时|
|开发分支所依赖的其他分支上的包的列表|在分支合并其他分支时|
|每个包的正式、前瞻版本所包含的功能列表|在正式、前瞻版本合并开发分支时|

在开发时，我们会消费以下元数据：

|元数据|何时消费|
|-|-|
|开发分支修改的包的列表|合并正式版后究竟是迭代开发版本，还是保持版本号|
|每个包的正式、前瞻版本所包含的功能列表|如何在合并完开发分支后递增版本号|
|开发分支所开发的功能的描述|在发布时生成 changelog|
|开发分支所依赖的其他分支上的包的列表|是否可以合并 PR|

由于元数据与具体开发无关，放在仓库的哪里存储就变成了一个问题。

目前较可行的解决方法：

|元数据|存储介质|
|-|-|
|开发分支所开发的功能的描述|分支作文件名的文件|
|开发分支修改的包的列表|版本号|
|开发分支所依赖的其他分支上的包的列表|分支作文件名的文件|
|每个包的正式、前瞻版本所包含的功能列表|分支作文件名的文件|

## 发布开发版本流程

使用伪代码表示开发版本的发布流程：

```text

循环一 {
  对于仓库里的每个包 {
    如果 (
      公开性不为私有
      且 (
        package.json 是本次提交新建的
        或 (
          本次提交变更了版本号
          且 当前版本与npm不同
        )
      )
    ) 则 {
      标记为需要发布
    }
  }

  如果 (
    当前提交是分支第一个提交
    或 当前所有包的版本都与npm相同
  ) 则 {
    退出循环一
  }

  回退到上一个提交
}

对于每个被标记的包 {
  带着标签发布
}
```

## 前瞻版本和正式版本发布流程

使用 ASCII 流程图表示：

```text

            /----------------\
            |    开发过程    |
            |                V
            |        |----------------|
            \--------|                |
                     |  发布开发版本  |
          /----------|                |-----------\
          |          |----------------|           |
          V                                       V
 |------------------|                     |------------------|
 |  汇总到前瞻分支  |                     |  汇总到正式分支  |
 |------------------|                     |------------------|
          |                                       |
          V                                       V
   /------------\                              /------------\
  / 是否存在开发 \  是  |-------------|  是   / 是否存在开发 \
 / 阶段小于 beta / ---->|  PR 不通过  |<---- / 阶段小于      /
 \ 的包         /       |-------------|      \ release 的包 /
  \------------/                              \------------/
          |                                       |
       否 |                                    否 |
          |                                       |
          \---------------------------------------/
                              |
                              V
                     |----------------|
                     |  处理 PR 冲突  |
                     |----------------|
                              |
                              V
               |----------------------------|
               |  根据分支元数据递增版本号  |
               |----------------------------|
                              |
                              V
                  |----------------------|
                  |  测试、打标签、发布  |
                  |----------------------|
```
