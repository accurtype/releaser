# 工具架构

## 功能实现列表

### 用户功能

- 在主分支上新建开发分支
- 在开发分支上新建开发分支
- 自动标记在其他地方新建的无效开发分支
- 自动修复更改了代码但未进入开发版本的包
- （自动）引入新的正式版
- （自动）阻挡未引入正式版的提交
- PR 辅助
- 自动删除已被合并的依赖分支
- 合并开发分支，也就是添加依赖分支

### 持续部署功能

- 检查更改了代码但未进入开发版本的包
- 发布开发版本
- 验证开发版本是否与正式版本相同
- 验证开发阶段是否足够 PR
- 生成 changelog
- 正式版本、前瞻版本的版本号递增
- 发布正式版本、前瞻版本
- 删除不需要的开发标签

## 元数据如何记录

元数据是与具体开发无关的，功能快速开发产生的，无法快速直接通过仓库得到的仓库描述数据。

### 产生的元数据

|元数据|何时产生|
|-|-|
|开发分支所开发的功能的描述|在分支被创建时|
|当前开发分支修改的包的列表|在包被修改时|
|所合并的其他分支上的包的列表|在合并其他分支时|

### 消费的元数据

|元数据|何时消费|
|-|-|
|当前开发分支修改的包的列表|合并正式版后判断包究竟是迭代开发版本，还是保持版本号时|
|开发分支所开发的功能的描述|在发布时生成 changelog 时|
|所合并的其他分支上的包的列表|在开发分支上：检查是否可以合并 PR 时；在主分支或前瞻分支上：判断如何递增版本号时|

### 元数据存储方法一览

由于元数据与具体开发无关，放在仓库的哪里存储就变成了一个问题。

目前较可行的解决方法：

|元数据|存储介质|
|-|-|
|开发分支所开发的功能的描述|分支信息文件|
|当前开发分支修改的包的列表|版本号|
|所合并的其他分支上的包的列表|分支信息文件|

### 分支信息文件

为了让开发者在平时开发时用 Git 无感跟踪这个文件，我们选择把它放在根目录下的 `.accureleaser` 文件夹里。
并且我们还规定每个分支都对应一个分支信息文件，而且每个分支只能修改以自己所对应的那个文件，这样子来防止分支合并时出现同一个文件被不同分支修改导致的合并冲突情况。

这种文件的文件名格式为 `branch_<name>`，其中 `<name>` 表示分支的名字。

根据上表，我们使用分支信息文件来存储三种元数据。
下面根据每个元数据详细讲解如何存储。

- **所合并的其他分支上的包的列表**

  有了这个元数据，在 PR 检查分支依赖链时就不需要遍历提交来查找依赖信息了。
  所以在存储设计上，我们也要考虑到如何使依赖链的检查更加方便。

  - 分支依赖链的主要信息是分支，所以我们要记录分支名称。
  - 依赖链的检查是为了防止有开发阶段过低的功能混入主分支中，所以我们需要存储包的版本。
  - 为了防止遍历提交，我们需要在每个提交中都存储整条依赖链。
    这个文件的存储方式考虑到了这种情况：合并分支时，Git 会把被合并分支的所有分支信息文件都加到自己分支里，其中也包括被合并分支所合并的分支的信息文件。
    由此我们仅在一个提交中，就能找到整条依赖链的信息。

  对于主分支和前瞻分支，这个元数据则兼具判断哪些分支被 PR 过的功能。

- **开发分支所开发的功能的描述**

  这个描述就是字符串，就普通的存储就行。

综上，分支信息文件的 JSON Schema 可以[在此查看](../lib/types.js#43:14)。

### 版本号

用版本号来存储哪些包被修改过是一种很方便的做法。
我们只需要在包被第一次修改的提交里，把包的版本变成开发版本，就可以用作标记了。
不需要额外文件，也不需要遍历提交。

## 发布开发版本流程

使用伪代码表示开发版本的发布流程：

```text

循环一 {
  对于仓库里的每个包 {
    如果 (
      公开性不为私有
      且 (
        package.json 是本次提交新建的
        或 (
          本次提交变更了版本号
          且 当前版本与npm不同
        )
      )
    ) 则 {
      标记为需要发布
    }
  }

  如果 (
    当前提交是分支第一个提交
    或 当前所有包的版本都与npm相同
  ) 则 {
    退出循环一
  }

  回退到上一个提交
}

对于每个被标记的包 {
  带着标签发布
}
```

## 前瞻版本和正式版本发布流程

使用 ASCII 流程图表示：

```text

            /----------------\
            |    开发过程    |
            |                V
            |        |----------------|
            \--------|                |
                     |  发布开发版本  |
          /----------|                |-----------\
          |          |----------------|           |
          V                                       V
 |------------------|                     |------------------|
 |  汇总到前瞻分支  |                     |  汇总到正式分支  |
 |------------------|                     |------------------|
          |                                       |
          V                                       V
   /------------\                              /------------\
  / 是否存在开发 \  是  |-------------|  是   / 是否存在开发 \
 / 阶段小于 beta / ---->|  PR 不通过  |<---- / 阶段小于      /
 \ 的包         /       |-------------|      \ release 的包 /
  \------------/                              \------------/
          |                                       |
       否 |                                    否 |
          |                                       |
          \---------------------------------------/
                              |
                              V
                     |----------------|
                     |  处理 PR 冲突  |
                     |----------------|
                              |
                              V
               |----------------------------|
               |  根据分支元数据递增版本号  |
               |----------------------------|
                              |
                              V
                  |----------------------|
                  |  测试、打标签、发布  |
                  |----------------------|
```
